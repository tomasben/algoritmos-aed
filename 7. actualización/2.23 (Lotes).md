## 2.23
Una empresa de distribución de energía eléctrica posee un archivo maestro con los siguientes datos de sus
clientes (la fecha de última lectura son las mediciones realizadas hasta el mes de mayo del 2014):

**Maestro** *ordenado por ID casa*
| Id Casa | Fecha de ultima lectura | Cantidad de lecturas | Promedio de lectura | Tipo de consumidor |
|---------|-------------------------|----------------------|---------------------|--------------------|

El campo tipo de consumidor puede ser:
- A, cuando el promedio de lectura es menor a 20K;
- B, cuando el promedio de lectura es menor a 40K; o
- C, cuando el promedio de lectura es igual o supera los 40K.

Cuenta además con el siguiente archivo con datos de las mediciones realizadas en los dos últimos años (desde junio
del 2014 hasta junio del 2016)

**Actualización** *ordenado por ID casa y Fecha de medición*
| Id Casa | Fecha de medición | Consumo |
|---------|-------------------|---------|

Se pide actualizar el archivo maestro con la información de las lecturas hasta el mes de enero del año 2015 inclusive.
Los campos que se deben actualizar son: la fecha de ultima lectura, cantidad de lecturas, el promedio y modificar, en
caso de ser necesario, el tipo de consumidor. En caso en que no exista el ID casa (una conexión nueva) se tiene que
crear en el maestro y actualizar los otros campos.

```
ACCION ejercicio ES
  AMBIENTE
    HV = 999999

    Fecha = REGISTRO
      año: N(4)
      mes: 1..12
      dia: 1..31
    FIN_REGISTRO

    Hogar = REGISTRO
      id_casa: N(10)
      ult_lec: Fecha
      cant_lec: real
      prom_lec: real
      tipo_consumidor: ('A', 'B', 'C')
    FIN_REGISTRO

    Medición = REGISTRO
      id_casa: N(10)
      fecha_med: Fecha
      consumo: real
    FIN_REGISTRO

    hogares, salida: archivo de Hogar ordenado por id_casa
    regmae, regsal, aux: Hogar
    mediciones: archivo de Medición ordenado por id_casa, fecha_med
    regmov: Medición

    PROCEDIMIENTO leer_hogares() ES
      LEER(hogares, regmae)
      SI FDA(hogares) ENTONCES
        regmae.id_casa := HV
      FIN_SI
    FIN_PROCEDIMIENTO

    PROCEDIMIENTO leer_mediciones() ES
      LEER(mediciones, regmov)
      SI FDA(mediciones) ENTONCES
        regmov.id_casa := HV
      FIN_SI
    FIN_PROCEDIMIENTO

    FUNCIÓN inferir_categoria(reg: Hogar): caracter ES
      SEGUN reg.prom_lec HACER
        < 20000: inferir_categoria := 'A'
        < 40000: inferir_categoria := 'B'
        >= 40000: inferir_categoria := 'C'
      FIN_SEGUN
    FIN_FUNCIÓN

    nuevo_promedio: real

    // https://en.wikipedia.org/wiki/Moving_average#Cumulative_average
    FUNCION promedio_incremental(promedio, incremento: real, n: entero): real ES
      promedio_incremental := promedio + (incremento - promedio) / (n + 1)
    FIN_FUNCIÓN

    PROCEDIMIENTO actualizar_consumos() ES
      MIENTRAS regsal.id_casa = regmov.id_casa HACER
        nuevo_promedio := promedio_incremental(regsal.prom_lec, regmov.consumo, regsal.cant_lec)

        regsal.ult_lect := regmov.fecha_med
        regsal.cant_lec := regsal.cant_lec + 1
        regsal.prom_lec := nuevo_promedio
        regsal.tipo_consumidor := inferir_categoria(regsal)

        leer_mediciones()
      FIN_MIENTRAS
    FIN_PROCEDIMIENTO
  PROCESO
    ABRIR E/ (hogares)
    ABRIR E/ (mediciones)
    ABRIR /S (salida)

    leer_hogares()
    leer_mediciones()

    MIENTRAS (regmae.id_casa <> HV) O (regmov.id_cassa <> HV) HACER
      SI (regmov.fecha_med.año < 2015) O (regmov.fecha_med.año = 2015 Y regmov.fecha_med.mes = 1) ENTONCES
        SI regmae.id_casa < regmov.id_casa ENTONCES
          regsal := regmae
          ESCRIBIR(salida, regsal)
          leer_hogares()
        CONTRARIO
          SI regmae.id_casa > regmov.id_casa ENTONCES
            regsal.id_casa := regmov.id_casa
            regsal.ult_lec := regmov.fecha_med
            regsal.cant_lec := 1
            regsal.prom_lec := regmov.consumo
            regsal.tipo_consumidor := inferir_categoria(regsal)

            leer_mediciones()
            actualizar_consumos()
            ESCRIBIR(salida, regsal)
          CONTRARIO
            regsal := regmae
            actualizar_consumos()
            ESCRIBIR(salida, regsal)

            leer_hogares()
            leer_mediciones(9)
          FIN_SI
        FIN_SI
      CONTRARIO
        leer_mediciones()
      FIN_SI
    FIN_MIENTRAS

    CERRAR(hogares)
    CERRAR(mediciones)
    CERRAR(salida)
FIN_ACCION
```
